<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         DefaultTargets="DeployOutput">
    <PropertyGroup>
        <TestRunnerDirectory>Tools\NUnit 2.2\</TestRunnerDirectory>
        <TestRunnerCommand>nunit-console.exe</TestRunnerCommand>
        <Artifacts>$(CCNetArtifactDirectory)</Artifacts>
    </PropertyGroup>
    
    <ItemGroup>
        <Project Include="TinyBDD\TinyBDD.csproj"></Project>
        <Project Include="TinyBDD.Specification\TinyBDD.Specification.csproj"></Project>
        <Project Include="TinyBDD.Specification.NUnit\TinyBDD.Specification.NUnit.csproj"></Project>
        <Project Include="TinyBDD.Specification.MSTest\TinyBDD.Specification.MSTest.csproj"></Project>
        <Project Include="TinyBDDTests\TinyBDDTests.csproj"></Project>
      
        <TinyBDDOutput Include="TinyBDD\bin\debug\TinyBDD*.dll"/>
        <TinyBDDOutput Include="TinyBDD.Specification\bin\debug\TinyBDD*.dll"/>
        <TinyBDDOutput Include="TinyBDD.Specification.NUnit\bin\debug\TinyBDD*.dll"/>
        <TinyBDDOutput Include="TinyBDD.Specification.MSTest\bin\debug\TinyBDD*.dll"/>
    </ItemGroup>

    <ItemGroup>
        <TestProject Include="TinyBDDTests\bin\debug\TinyBDDTests.dll"/>
    </ItemGroup>

    <Target Name="Compile">
        <MSBuild Projects="@(Project)" Targets="Build"/>
    </Target>
    
    <Target Name="Test" DependsOnTargets="Compile">
        <MakeDir Directories="Build"/>
        <MakeDir Directories="Build\artifacts"/>
        <MakeDir Directories="Build\bin"/>
        <MakeDir Directories="Build\bin\TinyBDD"/>
        <Exec WorkingDirectory="$(TestRunnerDirectory)" 
              Command="$(TestRunnerCommand) ..\..\@(TestProject) /xml=..\..\build\artifacts\TestResults.TinyBDDTests.xml"/>
    </Target>

    <Target Name="DeployOutput" DependsOnTargets="Test">
        <ItemGroup>
            <FilesToDelete Include="Build\bin\TinyBDD\*.*"/>
        </ItemGroup>
        <Delete Files="@(FilesToDelete)"/>
        <Copy SourceFiles="@(TinyBDDOutput)" DestinationFolder="Build\bin\TinyBDD"/>
    </Target>

    <Target Name="Artifacts" DependsOnTargets="DeployOutput">
        <Copy SourceFiles="Build\artifacts\TestResults.TinyBDDTests.xml"
              DestinationFolder="$(Artifacts)"/>

    </Target>
</Project>